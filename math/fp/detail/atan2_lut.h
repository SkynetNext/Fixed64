#pragma once

#include <array>
#include <cstdint>

namespace math::fp::detail {

// Arctangent lookup table with 257 entries for atan2 implementation
// Input range: [0, 1], Output: atan(x) in radians [0, pi/4]
// Fixed-point format: Q31.32
inline constexpr std::array<int64_t, 257> kAtan2LUT = {
    0LL,           // ratio=0.00000000000, angle=0.00000000000
    16842922LL,    // ratio=0.00392156863, angle=0.00392154852
    33685327LL,    // ratio=0.00784313725, angle=0.00784297644
    50526695LL,    // ratio=0.01176470588, angle=0.01176416315
    67366510LL,    // ratio=0.01568627451, angle=0.01568498812
    84204254LL,    // ratio=0.01960784314, angle=0.01960533086
    101039410LL,   // ratio=0.02352941176, angle=0.02352507099
    117871461LL,   // ratio=0.02745098039, angle=0.02744408822
    134699891LL,   // ratio=0.03137254902, angle=0.03136226242
    151524185LL,   // ratio=0.03529411765, angle=0.03527947359
    168343828LL,   // ratio=0.03921568627, angle=0.03919560193
    185158307LL,   // ratio=0.04313725490, angle=0.04311052781
    201967108LL,   // ratio=0.04705882353, angle=0.04702413184
    218769720LL,   // ratio=0.05098039216, angle=0.05093629488
    235565633LL,   // ratio=0.05490196078, angle=0.05484689804
    252354337LL,   // ratio=0.05882352941, angle=0.05875582272
    269135323LL,   // ratio=0.06274509804, angle=0.06266295062
    285908086LL,   // ratio=0.06666666667, angle=0.06656816378
    302672120LL,   // ratio=0.07058823529, angle=0.07047134458
    319426921LL,   // ratio=0.07450980392, angle=0.07437237578
    336171988LL,   // ratio=0.07843137255, angle=0.07827114052
    352906821LL,   // ratio=0.08235294118, angle=0.08216752236
    369630921LL,   // ratio=0.08627450980, angle=0.08606140529
    386343791LL,   // ratio=0.09019607843, angle=0.08995267374
    403044939LL,   // ratio=0.09411764706, angle=0.09384121263
    419733871LL,   // ratio=0.09803921569, angle=0.09772690736
    436410097LL,   // ratio=0.10196078431, angle=0.10160964384
    453073130LL,   // ratio=0.10588235294, angle=0.10548930853
    469722484LL,   // ratio=0.10980392157, angle=0.10936578840
    486357677LL,   // ratio=0.11372549020, angle=0.11323897103
    502978227LL,   // ratio=0.11764705882, angle=0.11710874457
    519583659LL,   // ratio=0.12156862745, angle=0.12097499776
    536173495LL,   // ratio=0.12549019608, angle=0.12483761999
    552747264LL,   // ratio=0.12941176471, angle=0.12869650128
    569304496LL,   // ratio=0.13333333333, angle=0.13255153230
    585844724LL,   // ratio=0.13725490196, angle=0.13640260440
    602367486LL,   // ratio=0.14117647059, angle=0.14024960964
    618872320LL,   // ratio=0.14509803922, angle=0.14409244076
    635358769LL,   // ratio=0.14901960784, angle=0.14793099125
    651826378LL,   // ratio=0.15294117647, angle=0.15176515533
    668274697LL,   // ratio=0.15686274510, angle=0.15559482798
    684703278LL,   // ratio=0.16078431373, angle=0.15941990495
    701111675LL,   // ratio=0.16470588235, angle=0.16324028278
    717499450LL,   // ratio=0.16862745098, angle=0.16705585883
    733866163LL,   // ratio=0.17254901961, angle=0.17086653124
    750211382LL,   // ratio=0.17647058824, angle=0.17467219901
    766534675LL,   // ratio=0.18039215686, angle=0.17847276197
    782835618LL,   // ratio=0.18431372549, angle=0.18226812083
    799113786LL,   // ratio=0.18823529412, angle=0.18605817715
    815368760LL,   // ratio=0.19215686275, angle=0.18984283337
    831600127LL,   // ratio=0.19607843137, angle=0.19362199286
    847807473LL,   // ratio=0.20000000000, angle=0.19739555985
    863990393LL,   // ratio=0.20392156863, angle=0.20116343953
    880148483LL,   // ratio=0.20784313725, angle=0.20492553801
    896281344LL,   // ratio=0.21176470588, angle=0.20868176234
    912388580LL,   // ratio=0.21568627451, angle=0.21243202051
    928469801LL,   // ratio=0.21960784314, angle=0.21617622150
    944524620LL,   // ratio=0.22352941176, angle=0.21991427524
    960552653LL,   // ratio=0.22745098039, angle=0.22364609266
    976553524LL,   // ratio=0.23137254902, angle=0.22737158568
    992526858LL,   // ratio=0.23529411765, angle=0.23109066720
    1008472284LL,  // ratio=0.23921568627, angle=0.23480325114
    1024389439LL,  // ratio=0.24313725490, angle=0.23850925246
    1040277960LL,  // ratio=0.24705882353, angle=0.24220858711
    1056137492LL,  // ratio=0.25098039216, angle=0.24590117209
    1071967682LL,  // ratio=0.25490196078, angle=0.24958692544
    1087768183LL,  // ratio=0.25882352941, angle=0.25326576623
    1103538651LL,  // ratio=0.26274509804, angle=0.25693761460
    1119278749LL,  // ratio=0.26666666667, angle=0.26060239175
    1134988143LL,  // ratio=0.27058823529, angle=0.26426001991
    1150666502LL,  // ratio=0.27450980392, angle=0.26791042242
    1166313503LL,  // ratio=0.27843137255, angle=0.27155352367
    1181928825LL,  // ratio=0.28235294118, angle=0.27518924913
    1197512152LL,  // ratio=0.28627450980, angle=0.27881752535
    1213063175LL,  // ratio=0.29019607843, angle=0.28243827997
    1228581587LL,  // ratio=0.29411764706, angle=0.28605144172
    1244067086LL,  // ratio=0.29803921569, angle=0.28965694041
    1259519375LL,  // ratio=0.30196078431, angle=0.29325470696
    1274938164LL,  // ratio=0.30588235294, angle=0.29684467338
    1290323163LL,  // ratio=0.30980392157, angle=0.30042677277
    1305674092LL,  // ratio=0.31372549020, angle=0.30400093934
    1320990671LL,  // ratio=0.31764705882, angle=0.30756710841
    1336272629LL,  // ratio=0.32156862745, angle=0.31112521638
    1351519696LL,  // ratio=0.32549019608, angle=0.31467520077
    1366731608LL,  // ratio=0.32941176471, angle=0.31821700020
    1381908108LL,  // ratio=0.33333333333, angle=0.32175055440
    1397048941LL,  // ratio=0.33725490196, angle=0.32527580419
    1412153857LL,  // ratio=0.34117647059, angle=0.32879269150
    1427222611LL,  // ratio=0.34509803922, angle=0.33230115938
    1442254965LL,  // ratio=0.34901960784, angle=0.33580115195
    1457250682LL,  // ratio=0.35294117647, angle=0.33929261445
    1472209533LL,  // ratio=0.35686274510, angle=0.34277549322
    1487131291LL,  // ratio=0.36078431373, angle=0.34624973568
    1502015735LL,  // ratio=0.36470588235, angle=0.34971529037
    1516862648LL,  // ratio=0.36862745098, angle=0.35317210689
    1531671821LL,  // ratio=0.37254901961, angle=0.35662013595
    1546443044LL,  // ratio=0.37647058824, angle=0.36005932935
    1561176116LL,  // ratio=0.38039215686, angle=0.36348963996
    1575870838LL,  // ratio=0.38431372549, angle=0.36691102173
    1590527019LL,  // ratio=0.38823529412, angle=0.37032342970
    1605144469LL,  // ratio=0.39215686275, angle=0.37372681997
    1619723004LL,  // ratio=0.39607843137, angle=0.37712114969
    1634262445LL,  // ratio=0.40000000000, angle=0.38050637711
    1648762617LL,  // ratio=0.40392156863, angle=0.38388246152
    1663223350LL,  // ratio=0.40784313725, angle=0.38724936325
    1677644478LL,  // ratio=0.41176470588, angle=0.39060704370
    1692025839LL,  // ratio=0.41568627451, angle=0.39395546530
    1706367277LL,  // ratio=0.41960784314, angle=0.39729459152
    1720668639LL,  // ratio=0.42352941176, angle=0.40062438687
    1734929777LL,  // ratio=0.42745098039, angle=0.40394481687
    1749150548LL,  // ratio=0.43137254902, angle=0.40725584807
    1763330812LL,  // ratio=0.43529411765, angle=0.41055744804
    1777470434LL,  // ratio=0.43921568627, angle=0.41384958534
    1791569283LL,  // ratio=0.44313725490, angle=0.41713222954
    1805627234LL,  // ratio=0.44705882353, angle=0.42040535120
    1819644163LL,  // ratio=0.45098039216, angle=0.42366892188
    1833619953LL,  // ratio=0.45490196078, angle=0.42692291409
    1847554491LL,  // ratio=0.45882352941, angle=0.43016730135
    1861447665LL,  // ratio=0.46274509804, angle=0.43340205812
    1875299371LL,  // ratio=0.46666666667, angle=0.43662715981
    1889109508LL,  // ratio=0.47058823529, angle=0.43984258282
    1902877978LL,  // ratio=0.47450980392, angle=0.44304830444
    1916604687LL,  // ratio=0.47843137255, angle=0.44624430293
    1930289546LL,  // ratio=0.48235294118, angle=0.44943055747
    1943932469LL,  // ratio=0.48627450980, angle=0.45260704815
    1957533376LL,  // ratio=0.49019607843, angle=0.45577375598
    1971092188LL,  // ratio=0.49411764706, angle=0.45893066285
    1984608831LL,  // ratio=0.49803921569, angle=0.46207775158
    1998083235LL,  // ratio=0.50196078431, angle=0.46521500584
    2011515335LL,  // ratio=0.50588235294, angle=0.46834241019
    2024905066LL,  // ratio=0.50980392157, angle=0.47145995006
    2038252372LL,  // ratio=0.51372549020, angle=0.47456761174
    2051557195LL,  // ratio=0.51764705882, angle=0.47766538236
    2064819485LL,  // ratio=0.52156862745, angle=0.48075324991
    2078039194LL,  // ratio=0.52549019608, angle=0.48383120318
    2091216277LL,  // ratio=0.52941176471, angle=0.48689923181
    2104350692LL,  // ratio=0.53333333333, angle=0.48995732625
    2117442403LL,  // ratio=0.53725490196, angle=0.49300547776
    2130491375LL,  // ratio=0.54117647059, angle=0.49604367837
    2143497578LL,  // ratio=0.54509803922, angle=0.49907192092
    2156460984LL,  // ratio=0.54901960784, angle=0.50209019902
    2169381569LL,  // ratio=0.55294117647, angle=0.50509850706
    2182259311LL,  // ratio=0.55686274510, angle=0.50809684017
    2195094194LL,  // ratio=0.56078431373, angle=0.51108519423
    2207886203LL,  // ratio=0.56470588235, angle=0.51406356589
    2220635326LL,  // ratio=0.56862745098, angle=0.51703195249
    2233341556LL,  // ratio=0.57254901961, angle=0.51999035212
    2246004887LL,  // ratio=0.57647058824, angle=0.52293876357
    2258625317LL,  // ratio=0.58039215686, angle=0.52587718634
    2271202846LL,  // ratio=0.58431372549, angle=0.52880562061
    2283737479LL,  // ratio=0.58823529412, angle=0.53172406726
    2296229222LL,  // ratio=0.59215686275, angle=0.53463252783
    2308678085LL,  // ratio=0.59607843137, angle=0.53753100455
    2321084079LL,  // ratio=0.60000000000, angle=0.54041950027
    2333447221LL,  // ratio=0.60392156863, angle=0.54329801851
    2345767528LL,  // ratio=0.60784313725, angle=0.54616656343
    2358045020LL,  // ratio=0.61176470588, angle=0.54902513981
    2370279720LL,  // ratio=0.61568627451, angle=0.55187375303
    2382471655LL,  // ratio=0.61960784314, angle=0.55471240912
    2394620853LL,  // ratio=0.62352941176, angle=0.55754111468
    2406727345LL,  // ratio=0.62745098039, angle=0.56035987690
    2418791163LL,  // ratio=0.63137254902, angle=0.56316870358
    2430812345LL,  // ratio=0.63529411765, angle=0.56596760305
    2442790928LL,  // ratio=0.63921568627, angle=0.56875658423
    2454726953LL,  // ratio=0.64313725490, angle=0.57153565660
    2466620463LL,  // ratio=0.64705882353, angle=0.57430483017
    2478471503LL,  // ratio=0.65098039216, angle=0.57706411549
    2490280121LL,  // ratio=0.65490196078, angle=0.57981352364
    2502046367LL,  // ratio=0.65882352941, angle=0.58255306621
    2513770292LL,  // ratio=0.66274509804, angle=0.58528275531
    2525451952LL,  // ratio=0.66666666667, angle=0.58800260355
    2537091401LL,  // ratio=0.67058823529, angle=0.59071262401
    2548688699LL,  // ratio=0.67450980392, angle=0.59341283029
    2560243905LL,  // ratio=0.67843137255, angle=0.59610323644
    2571757083LL,  // ratio=0.68235294118, angle=0.59878385697
    2583228295LL,  // ratio=0.68627450980, angle=0.60145470686
    2594657610LL,  // ratio=0.69019607843, angle=0.60411580154
    2606045095LL,  // ratio=0.69411764706, angle=0.60676715688
    2617390819LL,  // ratio=0.69803921569, angle=0.60940878918
    2628694855LL,  // ratio=0.70196078431, angle=0.61204071514
    2639957276LL,  // ratio=0.70588235294, angle=0.61466295192
    2651178158LL,  // ratio=0.70980392157, angle=0.61727551706
    2662357577LL,  // ratio=0.71372549020, angle=0.61987842849
    2673495613LL,  // ratio=0.71764705882, angle=0.62247170455
    2684592346LL,  // ratio=0.72156862745, angle=0.62505536396
    2695647857LL,  // ratio=0.72549019608, angle=0.62762942580
    2706662231LL,  // ratio=0.72941176471, angle=0.63019390954
    2717635552LL,  // ratio=0.73333333333, angle=0.63274883500
    2728567908LL,  // ratio=0.73725490196, angle=0.63529422234
    2739459385LL,  // ratio=0.74117647059, angle=0.63783009208
    2750310075LL,  // ratio=0.74509803922, angle=0.64035646507
    2761120067LL,  // ratio=0.74901960784, angle=0.64287336249
    2771889454LL,  // ratio=0.75294117647, angle=0.64538080583
    2782618330LL,  // ratio=0.75686274510, angle=0.64787881691
    2793306790LL,  // ratio=0.76078431373, angle=0.65036741786
    2803954929LL,  // ratio=0.76470588235, angle=0.65284663110
    2814562847LL,  // ratio=0.76862745098, angle=0.65531647934
    2825130641LL,  // ratio=0.77254901961, angle=0.65777698558
    2835658411LL,  // ratio=0.77647058824, angle=0.66022817311
    2846146259LL,  // ratio=0.78039215686, angle=0.66267006546
    2856594286LL,  // ratio=0.78431372549, angle=0.66510268647
    2867002597LL,  // ratio=0.78823529412, angle=0.66752606020
    2877371296LL,  // ratio=0.79215686275, angle=0.66994021098
    2887700488LL,  // ratio=0.79607843137, angle=0.67234516339
    2897990280LL,  // ratio=0.80000000000, angle=0.67474094222
    2908240779LL,  // ratio=0.80392156863, angle=0.67712757254
    2918452094LL,  // ratio=0.80784313725, angle=0.67950507960
    2928624334LL,  // ratio=0.81176470588, angle=0.68187348889
    2938757611LL,  // ratio=0.81568627451, angle=0.68423282611
    2948852034LL,  // ratio=0.81960784314, angle=0.68658311719
    2958907716LL,  // ratio=0.82352941176, angle=0.68892438821
    2968924771LL,  // ratio=0.82745098039, angle=0.69125666551
    2978903312LL,  // ratio=0.83137254902, angle=0.69357997556
    2988843453LL,  // ratio=0.83529411765, angle=0.69589434505
    2998745310LL,  // ratio=0.83921568627, angle=0.69819980083
    3008608999LL,  // ratio=0.84313725490, angle=0.70049636995
    3018434637LL,  // ratio=0.84705882353, angle=0.70278407959
    3028222342LL,  // ratio=0.85098039216, angle=0.70506295712
    3037972231LL,  // ratio=0.85490196078, angle=0.70733303004
    3047684423LL,  // ratio=0.85882352941, angle=0.70959432604
    3057359038LL,  // ratio=0.86274509804, angle=0.71184687291
    3066996196LL,  // ratio=0.86666666667, angle=0.71409069861
    3076596018LL,  // ratio=0.87058823529, angle=0.71632583123
    3086158624LL,  // ratio=0.87450980392, angle=0.71855229899
    3095684137LL,  // ratio=0.87843137255, angle=0.72077013023
    3105172678LL,  // ratio=0.88235294118, angle=0.72297935340
    3114624371LL,  // ratio=0.88627450980, angle=0.72517999710
    3124039338LL,  // ratio=0.89019607843, angle=0.72737209000
    3133417704LL,  // ratio=0.89411764706, angle=0.72955566092
    3142759592LL,  // ratio=0.89803921569, angle=0.73173073873
    3152065127LL,  // ratio=0.90196078431, angle=0.73389735245
    3161334434LL,  // ratio=0.90588235294, angle=0.73605553114
    3170567638LL,  // ratio=0.90980392157, angle=0.73820530400
    3179764865LL,  // ratio=0.91372549020, angle=0.74034670028
    3188926241LL,  // ratio=0.91764705882, angle=0.74247974932
    3198051892LL,  // ratio=0.92156862745, angle=0.74460448053
    3207141945LL,  // ratio=0.92549019608, angle=0.74672092340
    3216196526LL,  // ratio=0.92941176471, angle=0.74882910748
    3225215764LL,  // ratio=0.93333333333, angle=0.75092906240
    3234199785LL,  // ratio=0.93725490196, angle=0.75302081782
    3243148718LL,  // ratio=0.94117647059, angle=0.75510440348
    3252062689LL,  // ratio=0.94509803922, angle=0.75717984916
    3260941827LL,  // ratio=0.94901960784, angle=0.75924718470
    3269786261LL,  // ratio=0.95294117647, angle=0.76130643997
    3278596119LL,  // ratio=0.95686274510, angle=0.76335764490
    3287371530LL,  // ratio=0.96078431373, angle=0.76540082942
    3296112622LL,  // ratio=0.96470588235, angle=0.76743602355
    3304819525LL,  // ratio=0.96862745098, angle=0.76946325729
    3313492367LL,  // ratio=0.97254901961, angle=0.77148256070
    3322131278LL,  // ratio=0.97647058824, angle=0.77349396384
    3330736386LL,  // ratio=0.98039215686, angle=0.77549749681
    3339307822LL,  // ratio=0.98431372549, angle=0.77749318972
    3347845715LL,  // ratio=0.98823529412, angle=0.77948107269
    3356350193LL,  // ratio=0.99215686275, angle=0.78146117586
    3364821387LL,  // ratio=0.99607843137, angle=0.78343352938
    3373259426LL,  // ratio=1.00000000000, angle=0.78539816340
    3373259426LL   // ratio=1.00000000000, angle=0.78539816340
};

/**
 * @brief Lookup arctangent value for atan2 implementation with linear interpolation
 * @param ratio Fixed-point ratio value (y/x or x/y) in [0,1] range
 * @param P Precision (fractional bits) of the input
 * @return Fixed-point arctangent value with P fractional bits in [0, pi/4] range
 */
inline auto LookupAtan2(int64_t ratio, int P) noexcept -> int64_t {
    // Scale input to [0, 1] range in Q31.32 format
    constexpr int kTableP = 32;
    int64_t scaled_x;
    if (P > kTableP) {
        scaled_x = ratio >> (P - kTableP);
    } else if (P < kTableP) {
        scaled_x = ratio << (kTableP - P);
    } else {
        scaled_x = ratio;
    }

    // Ensure input is in valid range
    constexpr int64_t kOne = 1LL << kTableP;
    if (scaled_x >= kOne) {
        scaled_x = kOne - 1;
    }

    // Calculate table index and fractional part
    constexpr int kTableSize = 256;
    constexpr int64_t kIndexScale = (1LL << kTableP) / (kTableSize - 1);
    int index = static_cast<int>(scaled_x / kIndexScale);
    int64_t frac = scaled_x % kIndexScale;

    // Perform linear interpolation
    int64_t y0 = kAtan2LUT[index];
    int64_t y1 = kAtan2LUT[index + 1];
    int64_t result = y0 + ((y1 - y0) * frac) / kIndexScale;

    // Adjust precision if needed
    if (P > kTableP) {
        result = result << (P - kTableP);
    } else if (P < kTableP) {
        result = result >> (kTableP - P);
    }

    return result;
}

}  // namespace math::fp::detail
